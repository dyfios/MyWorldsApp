<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#000000" />
    <meta name="transparent" content="true">
    <meta
      name="description"
      content="MyWorlds Client UI"
    />
    <title>MyWorlds Client UI</title>
    <!-- Vuplex Polyfill - MUST run before React bundle loads -->
    <script>
      (function() {
        // Only set up polyfill if native vuplex isn't already present
        if (window.vuplex) {
          console.log('[index.html] Native vuplex already present');
          return;
        }
        
        console.log('[index.html] Setting up Vuplex polyfill for WebGL');
        
        var polyfill = {
          _listeners: {},
          addEventListener: function(eventName, listener) {
            if (!this._listeners[eventName]) this._listeners[eventName] = [];
            if (this._listeners[eventName].indexOf(listener) === -1) {
              this._listeners[eventName].push(listener);
            }
          },
          removeEventListener: function(eventName, listener) {
            if (!this._listeners[eventName]) return;
            var index = this._listeners[eventName].indexOf(listener);
            if (index !== -1) this._listeners[eventName].splice(index, 1);
          },
          postMessage: function(message) {
            var messageString = typeof message === 'string' ? message : JSON.stringify(message);
            var messageType = window.name ? 'vuplex.postMessage-' + window.name : 'vuplex.postMessage';
            console.log('[Polyfill] Sending to parent:', messageType, messageString);
            window.parent.postMessage({ type: messageType, message: messageString }, '*');
          },
          _emit: function(eventName) {
            var args = Array.prototype.slice.call(arguments, 1);
            if (!this._listeners[eventName]) return;
            this._listeners[eventName].forEach(function(listener) {
              try { listener.apply(null, args); } catch (e) { console.error(e); }
            });
          }
        };
        
        window.addEventListener('message', function(event) {
          if (event.data && typeof event.data.type === 'string' && 
              event.data.type.indexOf('vuplex.postMessage') === 0) {
            var value = event.data.message;
            var evt = new Event('vuplexmessage');
            evt.value = value;
            evt.data = value;
            window.dispatchEvent(evt);
            polyfill._emit('message', { value: value, data: value });
          }
        });
        
        window.vuplex = polyfill;
        
        // Also set up postWorldMessage immediately
        window.postWorldMessage = function(message) {
          console.log('[postWorldMessage] Called with:', message);
          if (window.vuplex && typeof window.vuplex.postMessage === 'function') {
            window.vuplex.postMessage(message);
          } else {
            console.warn('[postWorldMessage] vuplex not available');
          }
        };
        
        // Listen for native vuplex to arrive (Desktop mode)
        window.addEventListener('vuplexready', function() {
          console.log('[index.html] Native vuplex arrived, upgrading');
          // window.vuplex is now the native one
          // postWorldMessage will use it automatically
        });
      })();
    </script>
  </head>
  <body>
    <noscript>You need to enable JavaScript to run this app.</noscript>
    <div id="root"></div>
  </body>
</html>